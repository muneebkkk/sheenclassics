<%- include('partials/header') %>

    <main>
        <section class="section">
            <div class="container">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: start;">
                    <div>
                        <div class="image-gallery" style="position: relative;">
                            <div class="gallery-main" style="position: relative; overflow: hidden; border-radius: 10px; box-shadow: var(--shadow-lg);">
                                <button class="gallery-btn prev" aria-label="Previous image" style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; z-index: 10; cursor: pointer;">‹</button>
                                <button class="gallery-btn next" aria-label="Next image" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; z-index: 10; cursor: pointer;">›</button>
                                <img id="gallery-image" src="<%= product.images && product.images[0] ? product.images[0] : '/images/p1.jpeg' %>" alt="<%= product.name %>" style="width: 100%; display: block;">
                            </div>

                            <% if (product.images && product.images.length > 1) { %>
                                <div class="gallery-thumbs" style="display: flex; gap: 0.5rem; margin-top: 0.75rem; overflow-x: auto;">
                                    <% product.images.forEach(function(img, idx) { %>
                                        <button class="thumb-btn" data-index="<%= idx %>" style="border: none; padding: 0; background: transparent; cursor: pointer;">
                                        <img src="<%= img %>" alt="thumb-<%= idx %>" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid <%= idx === 0 ? 'var(--secondary-color)' : 'transparent' %>;">
                                    </button>
                                        <% }); %>
                                </div>
                                <% } %>
                        </div>
                    </div>
                    <div>
                        <h1 style="font-family: 'Playfair Display', serif; font-size: 2.5rem; margin-bottom: 1rem;">
                            <%= product.name %>
                        </h1>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem; font-size: 1.1rem;">
                            <%= product.category %>
                        </p>
                        <div style="margin-bottom: 2rem;">
                            <span style="font-size: 2.5rem; font-weight: 700; color: var(--secondary-color);">Rs<%= product.price.toFixed(2) %></span>
                            <% if (product.originalPrice && product.originalPrice > product.price) { %>
                                <span style="font-size: 1.5rem; color: var(--text-light); text-decoration: line-through; margin-left: 1rem;">Rs<%= product.originalPrice.toFixed(2) %></span>
                                <% } %>
                        </div>
                        <p style="margin-bottom: 2rem; line-height: 1.8; color: var(--text-dark);">
                            <%= product.description %>
                        </p>

                        <% if (product.sizes && product.sizes.length > 0) { %>
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label>Size:</label>
                                <select id="product-size" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 5px;">
                            <% product.sizes.forEach(size => { %>
                            <option value="<%= size %>"><%= size %></option>
                            <% }); %>
                        </select>
                            </div>
                            <% } %>

                                <% if (product.colors && product.colors.length > 0) { %>
                                    <div class="form-group" style="margin-bottom: 1.5rem;">
                                        <label>Color:</label>
                                        <select id="product-color" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 5px;">
                            <% product.colors.forEach(color => { %>
                            <option value="<%= color %>"><%= color %></option>
                            <% }); %>
                        </select>
                                    </div>
                                    <% } %>

                                        <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                                            <button class="btn btn-add-cart" style="flex: 1; padding: 1rem; font-size: 1.1rem;" onclick="addToCart('<%= product._id %>', document.getElementById('product-size')?.value || '', document.getElementById('product-color')?.value || '')">Add to Cart</button>
                                            <button class="btn btn-wishlist" style="width: 60px; font-size: 1.5rem;" onclick="addToWishlist('<%= product._id %>')">♡</button>
                                        </div>

                                        <div style="background: var(--accent-color); padding: 1.5rem; border-radius: 10px;">
                                            <p style="margin-bottom: 0.5rem;"><strong>Stock:</strong>
                                                <%= product.stock %> available</p>
                                            <% if (product.stock === 0) { %>
                                                <p style="color: #f44336;">Out of Stock</p>
                                                <% } %>
                                        </div>
                    </div>
                </div>

                <% if (relatedProducts && relatedProducts.length > 0) { %>
                    <div style="margin-top: 5rem;">
                        <h2 class="section-title">Related Products</h2>
                        <div class="product-grid">
                            <% relatedProducts.forEach(product => { %>
                                <div class="product-card" onclick="window.location.href='/products/<%= product._id %>'">
                                    <img src="<%= product.images && product.images[0] ? product.images[0] : '/images/p1.jpeg' %>" alt="<%= product.name %>" class="product-image">
                                    <div class="product-info">
                                        <h3 class="product-name">
                                            <%= product.name %>
                                        </h3>
                                        <div class="product-price">
                                            Rs
                                            <%= product.price.toFixed(2) %>
                                        </div>
                                        <div class="product-actions">
                                            <button class="btn btn-add-cart" onclick="event.stopPropagation(); addToCart('<%= product._id %>')">Add to Cart</button>
                                            <button class="btn btn-wishlist" onclick="event.stopPropagation(); addToWishlist('<%= product._id %>')">♡</button>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>
                        </div>
                    </div>
                    <% } %>
            </div>
        </section>
    </main>

    <%- include('partials/footer') %>

        <script>
            // Product image gallery: click buttons, thumbnails, arrow keys, swipe
            (function() {
                const images = [
                    <% if (product.images && product.images.length) { %>
                    <% product.images.forEach(function(img, idx) { %>
                    '<%= img %>'
                    <% if (idx < product.images.length - 1) { %>, <% } %>
                    <% }); %>
                    <% } else { %>
                    '/images/p1.jpeg'
                    <% } %>
                ];

                const galleryImage = document.getElementById('gallery-image');
                const prevBtn = document.querySelector('.gallery-btn.prev');
                const nextBtn = document.querySelector('.gallery-btn.next');
                const thumbBtns = Array.from(document.querySelectorAll('.thumb-btn'));
                let current = 0;

                function showImage(index) {
                    if (!images || images.length === 0) return;
                    current = (index + images.length) % images.length;
                    galleryImage.src = images[current];
                    // update active thumb border
                    thumbBtns.forEach(btn => {
                        const imgEl = btn.querySelector('img');
                        btn.style.outline = 'none';
                        if (parseInt(btn.dataset.index, 10) === current) {
                            imgEl.style.border = '2px solid var(--secondary-color)';
                        } else {
                            imgEl.style.border = '2px solid transparent';
                        }
                    });
                }

                function showNext() {
                    showImage(current + 1);
                }

                function showPrev() {
                    showImage(current - 1);
                }

                if (nextBtn) nextBtn.addEventListener('click', showNext);
                if (prevBtn) prevBtn.addEventListener('click', showPrev);

                // Thumbnails click
                thumbBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const idx = parseInt(this.dataset.index, 10);
                        showImage(idx);
                    });
                });

                // Keyboard navigation
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowLeft') showPrev();
                    if (e.key === 'ArrowRight') showNext();
                });

                // Touch swipe
                let touchStartX = 0;
                let touchEndX = 0;
                const galleryMain = document.querySelector('.gallery-main');
                if (galleryMain) {
                    galleryMain.addEventListener('touchstart', function(e) {
                        touchStartX = e.changedTouches[0].screenX;
                    }, {
                        passive: true
                    });

                    galleryMain.addEventListener('touchend', function(e) {
                        touchEndX = e.changedTouches[0].screenX;
                        const dx = touchEndX - touchStartX;
                        if (Math.abs(dx) > 40) {
                            if (dx < 0) showNext();
                            else showPrev();
                        }
                    });
                }

                // Init
                showImage(0);
            })();
        </script>