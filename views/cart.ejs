<%- include('partials/header') %>

    <main>
        <section class="section">
            <div class="container">

                <!-- Page Header -->
                <div class="section-header reveal" style="margin-bottom: 3rem;">
                    <span class="section-eyebrow">Review</span>
                    <h1 class="section-title">Your <em>Cart</em></h1>
                    <div class="section-divider"></div>
                </div>

                <% if (cart && cart.items && cart.items.length > 0) { %>

                    <%
                let subtotal = 0;
                let deliveryCharge = 0;
                cart.items.forEach(item => {
                    subtotal += item.product.price * item.quantity;
                    const fee = (item.product && typeof item.product.shippingFee === 'number') ? item.product.shippingFee : 250;
                    deliveryCharge += fee * item.quantity;
                });
                const total = subtotal + deliveryCharge;
            %>

                        <div class="cart-layout">
                            <!-- Cart Items -->
                            <div class="cart-items-col">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; padding-bottom:1rem; border-bottom:1px solid var(--border);">
                                    <span style="font-size:0.78rem; font-weight:600; letter-spacing:0.1em; text-transform:uppercase; color:var(--text-muted);"><%= cart.items.length %> Item<%= cart.items.length !== 1 ? 's' : '' %></span>
                                    <a href="/products" style="font-size:0.82rem; color:var(--gold); font-weight:500; display:flex; align-items:center; gap:4px;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Continue Shopping
                                    </a>
                                </div>

                                <% cart.items.forEach((item, i) => { %>
                                    <div class="cart-item reveal" style="animation-delay: <%= i * 0.08 %>s">
                                        <img src="<%= item.product.images && item.product.images[0] ? item.product.images[0] : '/images/p1.jpeg' %>" alt="<%= item.product.name %>" class="cart-item-image">

                                        <div class="cart-item-details">
                                            <div style="display:flex; justify-content:space-between; align-items:start; gap:1rem;">
                                                <div>
                                                    <h3 class="cart-item-name">
                                                        <%= item.product.name %>
                                                    </h3>
                                                    <div style="display:flex; gap:1.2rem; margin-top:0.3rem; flex-wrap:wrap;">
                                                        <% if (item.size) { %>
                                                            <span style="font-size:0.78rem; color:var(--text-muted); letter-spacing:0.05em;">
                                            Size: <strong style="color:var(--text-secondary)"><%= item.size %></strong>
                                        </span>
                                                            <% } %>
                                                                <% if (item.color) { %>
                                                                    <span style="font-size:0.78rem; color:var(--text-muted); letter-spacing:0.05em;">
                                            Color: <strong style="color:var(--text-secondary)"><%= item.color %></strong>
                                        </span>
                                                                    <% } %>
                                                    </div>
                                                </div>
                                                <div class="cart-item-price">Rs
                                                    <%= (item.product.price * item.quantity).toFixed(2) %>
                                                </div>
                                            </div>

                                            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:1.2rem; flex-wrap:wrap; gap:1rem;">
                                                <div class="quantity-control">
                                                    <button class="quantity-btn" onclick="updateCartQuantity('<%= item._id %>', <%= item.quantity - 1 %>)">‚àí</button>
                                                    <span class="quantity-value"><%= item.quantity %></span>
                                                    <button class="quantity-btn" onclick="updateCartQuantity('<%= item._id %>', <%= item.quantity + 1 %>)">+</button>
                                                </div>

                                                <button onclick="removeFromCart('<%= item._id %>')" style="background:none; border:none; cursor:pointer; font-size:0.78rem; font-weight:500; color:var(--text-muted); letter-spacing:0.05em; display:flex; align-items:center; gap:4px; transition:color 0.2s; font-family:var(--font-body);"
                                                    onmouseover="this.style.color='#e74c3c'" onmouseout="this.style.color='var(--text-muted)'">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/></svg>
                                    Remove
                                </button>
                                            </div>

                                            <div style="margin-top:0.8rem; padding-top:0.8rem; border-top:1px solid var(--border); display:flex; justify-content:space-between; font-size:0.8rem; color:var(--text-muted);">
                                                <span>Unit price: Rs <%= item.product.price.toFixed(2) %></span>
                                                <span>Shipping: Rs <%= ((item.product && typeof item.product.shippingFee === 'number') ? item.product.shippingFee : 250).toFixed(2) %></span>
                                            </div>
                                        </div>
                                    </div>
                                    <% }); %>
                            </div>

                            <!-- Order Summary -->
                            <div>
                                <div class="cart-summary reveal reveal-delay-2">
                                    <h3>Order Summary</h3>

                                    <div class="summary-row">
                                        <span>Subtotal</span>
                                        <span>Rs <%= subtotal.toFixed(2) %></span>
                                    </div>
                                    <div class="summary-row">
                                        <span>Shipping</span>
                                        <span id="cart-shipping">Rs <%= deliveryCharge.toFixed(2) %></span>
                                    </div>
                                    <div class="summary-row" style="color:var(--text-muted); font-size:0.8rem;">
                                        <span>Estimated Tax</span>
                                        <span>‚Äî</span>
                                    </div>
                                    <div class="summary-row total">
                                        <span>Total</span>
                                        <span style="color:var(--gold);">Rs <%= total.toFixed(2) %></span>
                                    </div>

                                    <a href="/orders/summary" class="btn btn-add-cart" style="width:100%; margin-top:1.5rem; padding:1rem; font-size:0.85rem; border-radius:var(--radius-sm); display:flex; justify-content:center; align-items:center; gap:8px; text-decoration:none;">
                                        <span>Proceed to Checkout</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                                    </a>

                                    <p style="text-align:center; font-size:0.75rem; color:var(--text-muted); margin-top:1rem; display:flex; align-items:center; justify-content:center; gap:4px;">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Secure checkout
                                    </p>
                                </div>
                            </div>
                        </div>

                        <% } else { %>
                            <!-- Empty Cart -->
                            <div class="empty-state reveal">
                                <div class="empty-state-icon">üõçÔ∏è</div>
                                <h3>Your cart is empty</h3>
                                <p style="margin-bottom:2rem;">Discover our curated collection of premium embroidered pieces.</p>
                                <a href="/products" class="btn btn-add-cart" style="display:inline-flex; padding:0.85rem 2.5rem;">
                                    <span>Browse Collection</span>
                                </a>
                            </div>
                            <% } %>

            </div>
        </section>
    </main>

    <script>
        // Scroll reveal
        const revealObserver = new IntersectionObserver((entries) => {
            entries.forEach(e => {
                if (e.isIntersecting) {
                    e.target.classList.add('visible');
                    revealObserver.unobserve(e.target);
                }
            });
        }, {
            threshold: 0.08
        });
        document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));

        // Navbar scroll
        const navbar = document.querySelector('.navbar');
        window.addEventListener('scroll', () => {
            navbar.classList.toggle('scrolled', window.scrollY > 30);
        }, {
            passive: true
        });

        // Mobile menu
        const toggle = document.querySelector('.mobile-menu-toggle');
        const menu = document.querySelector('.nav-menu');
        const overlay = document.querySelector('.nav-overlay');
        if (toggle && menu) {
            function toggleMenu(open) {
                toggle.classList.toggle('open', open);
                menu.classList.toggle('active', open);
                overlay && overlay.classList.toggle('active', open);
                document.body.style.overflow = open ? 'hidden' : '';
            }
            toggle.addEventListener('click', () => toggleMenu(!menu.classList.contains('active')));
            overlay && overlay.addEventListener('click', () => toggleMenu(false));
        }
    </script>

    <%- include('partials/footer') %>